<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Steam Discounts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="https://store.steampowered.com/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
    <style>
        :root {
            --accent-color: #58a6ff;
            --background-dark: #1a1a1a;
            --background-medium: #2d2d2d;
            --background-light: #3d3d3d;
        }

        body {
            background-color: var(--background-dark);
            color: white;
        }

        .table-dark {
            background-color: var(--background-medium);
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: var(--background-light);
        }

        .discount-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            background-size: 200% 100%;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .discount-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            background: linear-gradient(
                90deg,
                rgba(0,0,0,0.3) 0%,
                rgba(0,0,0,0.1) 50%,
                rgba(0,0,0,0.3) 100%
            );
        }

        .discount-text {
            position: relative;
            z-index: 2;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .game-name {
            display: flex;
            text-align: center;
            color: black;
            font-size: 24px;
            margin: 5px;
        }

        .game-row {
            gap: 12px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            border: 2px solid var(--background-dark);
            font-size: 16px;
        }

        .game-image {
            width: 120px;
            height: 45px;
            border-radius: 5px;
        }

        .game-link {
            width: 100%;
            height: 100%;
        }

        .game-link:hover {
            text-decoration: none;
        }

        tr:hover {
            background-color: #454d55 !important;
            cursor: pointer;
        }

        .form-control {
            background-color: var(--background-medium);
            color: white;
            border: 1px solid var(--background-light);
        }

        .form-control:focus {
            background-color: var(--background-medium);
            color: white;
            border-color: var(--accent-color);
            box-shadow: none;
        }

        .filter-container {
            display: flex;
            gap: 20px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 300px;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .slider-input {
            width: 80px;
            flex-shrink: 0;
        }

        .noUi-target {
            background: #454d55;
            border-radius: 3px;
            border: 1px solid var(--accent-color);
            height: 6px;
            flex-grow: 1;
        }

        .noUi-connect {
            background: var(--accent-color);
        }

        .noUi-handle {
            width: 18px !important;
            height: 18px !important;
            right: -9px !important;
            top: -7px !important;
            border-radius: 50%;
            background: var(--background-medium);
            border: 2px solid var(--accent-color);
            cursor: pointer;
            box-shadow: none;
        }

        .github-link {
            color: var(--accent-color) !important;
            text-decoration: none !important;
        }

        .github-link:hover {
            opacity: 0.8;
        }

        .noUi-handle:after, .noUi-handle:before {
            content: none;
        }
    </style>
    <style>
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
            margin-left: 5px;
        }

        .game-tag {
            display: inline-block;
            padding: 2px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
            color: #333;
            font-weight: 700;
            white-space: nowrap;
        }

        .game-tag:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }

        .game-tag-not-selected {
            display: inline-block;
            padding: 2px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: rgba(255, 0, 0, 0.3);
            font-size: 12px;
            color: #333;
            font-weight: 700;
            white-space: nowrap;
        }

        .game-tag-not-selected:hover {
            background-color: rgba(255, 0, 0, 0.5);
        }

        .game-tag-selected {
            display: inline-block;
            padding: 2px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: rgba(0, 255, 0, 0.3);
            font-size: 12px;
            color: #333;
            font-weight: 700;
            white-space: nowrap;
        }

        .game-tag-selected:hover {
            background-color: rgba(0, 255, 0    , 0.5);
        }
    </style>
    <style>
        .pagination-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .pagination {
            flex-wrap: wrap;
        }

        .page-item {
            cursor: pointer;
            margin: 2px;
        }

        .page-link {
            background-color: var(--background-medium);
            border-color: var(--background-light);
            color: var(--accent-color);
            min-width: 40px;
            text-align: center;
        }

        .page-item.active .page-link {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .page-link:hover {
            background-color: var(--background-light);
        }
    </style>
    <style>
        .tags-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
            min-height: 38px;
            padding: 5px;
            border: 1px solid var(--background-light);
            border-radius: 4px;
            background-color: var(--background-medium);
        }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            padding: 3px 8px;
            border: 1px solid var(--accent-color);
            border-radius: 3px;
            background-color: rgba(var(--accent-color-rgb), 0.2);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-tag:hover {
            background-color: rgba(var(--accent-color-rgb), 0.3);
        }

        .filter-tag .remove-tag {
            margin-left: 5px;
            font-size: 16px;
            line-height: 1;
        }

        .filter-tag .remove-tag:hover {
            color: var(--accent-color);
        }

        .add-tag {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px dashed var(--background-light);
        }

        .add-tag:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .add-tag-text {
            margin-left: 5px;
            font-size: 14px;
        }

        .modal-content {
            background-color: var(--background-dark);
            color: white;
        }

        .modal-header {
            border-bottom: 1px solid var(--background-light);
        }

        .modal-header .close {
            color: white;
        }

        .modal-title {
            color: white;
        }

        .tags-modal-body {
            display: flex;
            flex-direction: column;
            padding: 0;
            max-height: 70vh;
            overflow-y: auto;
        }

        .tag-search-container {
            padding: 15px;
            position: sticky;
            top: 0;
            background-color: var(--background-dark);
            z-index: 10;
            border-bottom: 1px solid var(--background-light);
        }

        .tag-search-input {
            width: 100%;
            margin-bottom: 10px;
        }

        .tags-alphabet-container {
            padding: 0 15px 15px;
        }

        .letter-group {
            margin-bottom: 15px;
        }

        .letter-header {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-color);
            margin: 10px 0 5px;
            padding-bottom: 3px;
            border-bottom: 1px solid var(--background-light);
        }

        .no-tags {
            color: var(--text-muted);
            font-style: italic;
            font-size: 14px;
            padding: 5px 0;
        }

        .letter-divider {
            height: 1px;
            background-color: var(--background-light);
            margin: 10px 0;
            opacity: 0.3;
        }

        .modal-tag {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            margin: 3px;
            border: 1px solid var(--background-light);
            border-radius: 3px;
            background-color: var(--background-medium);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-tag-selected {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            cursor: default;
            opacity: 0.7;
        }

        .modal-tag-selected:hover {
            transform: none;
            background-color: var(--accent-color);
        }

        .modal-tag:hover:not(.modal-tag-selected) {
            background-color: var(--accent-color-light);
            transform: translateY(-2px);
        }

        .modal-tag:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .modal-lg {
            max-width: 800px;
        }

        .selected-check {
            margin-left: 5px;
            font-weight: bold;
        }
    </style>
    <style>
        .platform-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .platform-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .additional-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .additional-filter {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        input[type="checkbox"] {
            cursor: pointer;
        }
    </style>
    <style>
        .game-meta-info {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            width: 100%;
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-muted);
        }

        .platform-icons {
            display: flex;
            gap: 5px;
        }

        .platform-icon {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            line-height: 1;
        }

        .win-icon {
            background-color: #0078d7;
            color: white;
        }

        .mac-icon {
            background-color: #555555;
            color: white;
        }

        .linux-icon {
            background-color: #f0a30a;
            color: black;
        }

        .vr-icon {
            display: flex;
            align-items: center;
            background-color: #6a35b8;
            color: white;
        }

        .content-type {
            padding: 2px 6px;
            border-radius: 3px;
            background-color: rgba(255, 255, 255, 0.1);
            font-style: italic;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZP7K8BBV1G"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-ZP7K8BBV1G');
    </script>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
    
       ym(101470207, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
       });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/101470207" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    <div class="container">
        <div class="my-4">
            <div class="d-flex align-items-center mb-3">
                <span class="mr-2">Total Count:</span>
                <span id="totalcount" class="badge badge-secondary"></span>
            </div>

            <div class="filter-container">
                <div class="filter-group">
                    <input type="text" class="form-control" id="nameFilter" placeholder="Search game...">
                </div>

                <div class="filter-group">
                    <div class="slider-group">
                        <input type="number" class="form-control slider-input" id="minDiscount" placeholder="Min%">
                        <div id="discountSlider" style="flex-grow:1;"></div>
                        <input type="number" class="form-control slider-input" id="maxDiscount" placeholder="Max%">
                    </div>
                </div>

                <div class="filter-group">
                    <div class="slider-group">
                        <input type="number" class="form-control slider-input" id="minPrice" placeholder="Min$">
                        <div id="priceSlider" style="flex-grow:1;"></div>
                        <input type="number" class="form-control slider-input" id="maxPrice" placeholder="Max$">
                    </div>
                </div>

                <div class="filter-group">
                    <div class="platform-filters">
                        <label class="platform-checkbox">
                            <input type="checkbox" id="winFilter"> Windows
                        </label>
                        <label class="platform-checkbox">
                            <input type="checkbox" id="macFilter"> Mac
                        </label>
                        <label class="platform-checkbox">
                            <input type="checkbox" id="linuxFilter"> Linux
                        </label>
                    </div>

                    <div class="additional-filters">
                        <label class="additional-filter">
                            <input type="checkbox" id="appFilter" checked> Apps
                        </label>
                        <label class="additional-filter">
                            <input type="checkbox" id="bundleFilter" checked> Bundles
                        </label>
                        <label class="additional-filter">
                            <input type="checkbox" id="soundtrackFilter" checked> Soundtracks
                        </label>
                    </div>
                    
                    <div class="additional-filters">
                        <label class="additional-filter">
                            <input type="checkbox" id="vrFilter"> VR Only
                        </label>
                    </div>
                </div>
            </div>

            <div id="pagination" class="pagination-container"></div>

            <table class="table table-striped table-dark">
                <tbody id="listcontent"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" class="text-center">
                            Latest Updated (UTC+3): <span id="uptime" style="color: #ff6666;"></span>
                        </td>
                    </tr>
                </tfoot>
            </table>

            <div class="text-center my-4">
                <a href="https://github.com/LexKreyn/NeedFree" 
                   class="github-link" 
                   target="_blank">
                    <svg version="1.1" width="24" height="24" viewBox="0 0 16 16" 
                         class="octicon octicon-mark-github" aria-hidden="true">
                        <path fill="currentColor" fill-rule="evenodd" 
                              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    <span class="ml-2">View on GitHub</span>
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let allGames = [];
        let discountSlider, priceSlider;
        let filterTimeout;
        let selectedTags = [];
        let allAvailableTags = [];
        let modalEventHandlersAttached = false;

        const DEBOUNCE_DELAY = 500;

        let currentPage = 1;
        const itemsPerPage = 100;
        let filteredGames = [];
        const pageBorder = 2;

        let platformFilters = {
            win: false,
            mac: false,
            linux: false
        };
        let vrFilter = false;
        let appFilter = true;
        let bundleFilter = true;
        let soundtrackFilter = true;

        function getColor(percent) {
            percent = Math.max(1, Math.min(100, percent));
            const hue = (percent * 120 / 100).toString(10);
            return `hsl(${hue}, 100%, 45%)`;
        }

        function renderGames(games, page = 1) {
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pagedGames = games.slice(start, end);

            const fragment = document.createDocumentFragment();

            pagedGames.forEach(game => {
                const tr = document.createElement('tr');
                tr.className = 'table-success';
                let tagsHTML = '';
                if (game.tags && game.tags.length > 0) {
                    tagsHTML = `
                        <div class="tags-container">
                            ${game.tags.map(tag => {
                                const tagId = parseInt(Object.keys(allAvailableTags).find(
                                    key => allAvailableTags[key] === tag
                                ));
                                const isSelected = selectedTags.includes(tagId);

                                let tagClass = 'game-tag';
                                if (selectedTags.length > 0) {
                                    tagClass = isSelected ? 'game-tag-selected' : 'game-tag-not-selected';
                                }

                                return `<span class="${tagClass}">${tag}</span>`;
                            }).join('')}
                        </div>
                    `;
                }
                tr.innerHTML = `
                    <td class="game-row" 
                        style="background: linear-gradient(90deg, ${getColor(game.discount)} 0%, var(--background-dark) 100%)">
                        <a href="${game.link}" class="game-link" target="_blank">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <img class="game-image" src="${game.image}" alt="${game.name} cover">
                                <div class="discount-badge">
                                    <span class="discount-text">-${game.discount}%</span>
                                </div>
                                <div class="discount-badge">
                                    <span class="discount-text">
                                        ${game.originalPrice} → ${game.discountPrice}
                                    </span>
                                </div>
                            </div>
                            <div class="game-name">${game.name}</div>
                            
                            <div class="game-meta-info">
                                <div class="content-type">
                                    ${game.is_bundle ? 'Bundle' : game.is_soundtrack ? 'Soundtrack' : 'App'}
                                </div>
                                <div class="platform-icons">
                                    ${game.for_win ? '<img src="https://store.fastly.steamstatic.com/public/images/v6/icon_platform_win.png" class="platform-icon" title="Windows">' : ''}
                                    ${game.for_mac ? '<img src="https://store.fastly.steamstatic.com/public/images/v6/icon_platform_mac.png" class="platform-icon" title="Windows">' : ''}
                                    ${game.for_linux ? '<img src="https://store.fastly.steamstatic.com/public/images/v6/icon_platform_linux.png" class="platform-icon" title="Windows">' : ''}
                                    ${game.for_vr ? '<span class="platform-icon vr-icon" title="VR Supported">VR</span>' : ''}
                                </div>
                            </div>
                            
                            <!-- Блок с тегами -->
                            ${tagsHTML}
                        </a>
                    </td>
                `;
                fragment.appendChild(tr);
            });

            $('#listcontent').empty().append(fragment);
            $('#totalcount').text(`${pagedGames.length} of ${filteredGames.length}/${allGames.length} (Page ${page}/${Math.ceil(filteredGames.length/itemsPerPage)})`);
        }

        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pagination = $('#pagination');
            pagination.empty();

            const paginationList = $('<ul>').addClass('pagination');

            // Previous Button
            const prevItem = $('<li>').addClass('page-item' + (currentPage === 1 ? ' disabled' : ''));
            prevItem.append($('<a>').addClass('page-link')
                .text('<')
                .click(() => {
                    if(currentPage > 1) {
                        currentPage--;
                        renderGames(filteredGames, currentPage);
                        updatePagination(filteredGames.length);
                    }
                }));
            paginationList.append(prevItem);

            // Page Numbers
            const startPage = Math.max(1, currentPage - pageBorder);
            const endPage = Math.min(totalPages, currentPage + pageBorder);

            if (currentPage > (pageBorder + 1)) {
                const firstPage = $('<li>').addClass('page-item' + (1 === currentPage ? ' active' : ''));
                firstPage.append($('<a>').addClass('page-link')
                    .text(1)
                    .click(() => {
                        currentPage = 1;
                        renderGames(filteredGames, currentPage);
                        updatePagination(filteredGames.length);
                    }));
                paginationList.append(firstPage);
            }
            if (currentPage > (pageBorder + 2)) {
                const firstEmptyPage = $('<li>').addClass('page-item');
                firstEmptyPage.append($('<a>').addClass('page-link').text('..'));
                paginationList.append(firstEmptyPage);
            }

            for(let i = startPage; i <= endPage; i++) {
                const pageItem = $('<li>').addClass('page-item' + (i === currentPage ? ' active' : ''));
                pageItem.append($('<a>').addClass('page-link')
                    .text(i)
                    .click(() => {
                        currentPage = i;
                        renderGames(filteredGames, currentPage);
                        updatePagination(filteredGames.length);
                    }));
                paginationList.append(pageItem);
            }

            if (currentPage < (totalPages - pageBorder - 1)) {
                const lastEmptyPage = $('<li>').addClass('page-item');
                lastEmptyPage.append($('<a>').addClass('page-link').text('..'));
                paginationList.append(lastEmptyPage);
            }
            if (currentPage < (totalPages - pageBorder - 0)) {
                const lastPage = $('<li>').addClass('page-item' + (totalPages === currentPage ? ' active' : ''));
                lastPage.append($('<a>').addClass('page-link')
                    .text(totalPages)
                    .click(() => {
                        currentPage = totalPages;
                        renderGames(filteredGames, currentPage);
                        updatePagination(filteredGames.length);
                    }));
                paginationList.append(lastPage);
            }

            // Next Button
            const nextItem = $('<li>').addClass('page-item' + (currentPage === totalPages ? ' disabled' : ''));
            nextItem.append($('<a>').addClass('page-link')
                .text('>')
                .click(() => {
                    if(currentPage < totalPages) {
                        currentPage++;
                        renderGames(filteredGames, currentPage);
                        updatePagination(filteredGames.length);
                    }
                }));
            paginationList.append(nextItem);

            pagination.append(paginationList);
        }

        function initSliders(maxPrice) {
            discountSlider = noUiSlider.create(document.getElementById('discountSlider'), {
                start: [0, 100],
                connect: true,
                range: { min: 0, max: 100 },
                step: 1,
                format: {
                    to: value => Math.round(value),
                    from: value => Number(value)
                },
                behaviour: 'drag-tap'
            });

            priceSlider = noUiSlider.create(document.getElementById('priceSlider'), {
                start: [0, maxPrice],
                connect: true,
                range: { min: 0, max: maxPrice },
                step: 0.01,
                format: {
                    to: value => value.toFixed(2),
                    from: value => Number(value)
                }
            });

            setupSliderSync(discountSlider, 'minDiscount', 'maxDiscount');
            setupSliderSync(priceSlider, 'minPrice', 'maxPrice');
        }

        function setupSliderSync(slider, minId, maxId) {
            const minInput = document.getElementById(minId);
            const maxInput = document.getElementById(maxId);

            slider.on('update', values => {
                minInput.value = values[0];
                maxInput.value = values[1];
                debouncedFilter();
            });

            [minInput, maxInput].forEach(input => {
                input.addEventListener('change', () => {
                    slider.set([minInput.value || 0, maxInput.value || slider.options.range.max]);
                });
            });
        }

        function debouncedFilter() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(filterGames, DEBOUNCE_DELAY);
        }

        function filterGames() {
            const searchText = $('#nameFilter').val().toLowerCase();
            const [minDiscount, maxDiscount] = discountSlider.get();
            const [minPrice, maxPrice] = priceSlider.get();

            filteredGames = allGames.filter(game => {
                const nameMatch = game.name.toLowerCase().includes(searchText);
                const discountMatch = game.discount >= minDiscount && game.discount <= maxDiscount;
                const priceMatch = game.numericPrice >= minPrice && game.numericPrice <= maxPrice;
                
                let tagsMatch = true;
                if (selectedTags.length > 0) {
                    if (!game.tags || !game.numericTags) return false;
                    tagsMatch = selectedTags.every(tagId => 
                        game.numericTags.includes(tagId)
                    );
                }
                
                const platformMatch = 
                    (!platformFilters.win || game.for_win) &&
                    (!platformFilters.mac || game.for_mac) &&
                    (!platformFilters.linux || game.for_linux);
                
                const vrMatch = !vrFilter || game.for_vr;
                
                let matchApp = false;
                let matchBundle = false;
                let matchSoundtrack = false;
                if (appFilter && (game.is_bundle == false && game.is_soundtrack == false)) {
                    matchApp = true;
                }
                if (bundleFilter && (game.is_bundle == true)) {
                    matchBundle = true;
                }
                if (soundtrackFilter && (game.is_bundle == false && game.is_soundtrack == true)) {
                    matchSoundtrack = true;
                }
                const contentMatch = matchApp || matchBundle || matchSoundtrack;
                
                return nameMatch && discountMatch && priceMatch && tagsMatch && platformMatch && vrMatch && contentMatch;
            });

            currentPage = 1;
            renderGames(filteredGames, currentPage);
            updatePagination(filteredGames.length);
            renderTagFilter();
        }

        function showTagModal() {
            // const availableTags = Object.entries(allAvailableTags)
            //     .filter(([id, tag]) => !selectedTags.includes(parseInt(id)))
            //     .reduce((acc, [id, tag]) => ({ ...acc, [id]: tag }), {});
            const availableTags = allAvailableTags;

            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

            const groupedTags = {};
            alphabet.forEach(letter => {
                groupedTags[letter] = Object.entries(availableTags)
                    .filter(([id, tag]) => tag.charAt(0).toUpperCase() === letter)
                    .sort((a, b) => a[1].localeCompare(b[1]));
            });

            $('#tagsModal').remove();

            const modal = $(`
                <div class="modal fade" id="tagsModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Select Tags</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body tags-modal-body">
                                <div class="tag-search-container">
                                    <input type="text" class="form-control tag-search-input" placeholder="Search tags...">
                                </div>
                                <div class="tags-alphabet-container">
                                    ${alphabet.map(letter => `
                                        <div class="letter-group" data-letter="${letter}">
                                            <div class="letter-header">${letter}</div>
                                            <div class="tags-row">
                                                ${groupedTags[letter].length > 0 ? 
                                                    groupedTags[letter].map(([id, tag]) => {
                                                        const isSelected = selectedTags.includes(parseInt(id));
                                                        return `
                                                            <span class="modal-tag ${isSelected ? 'modal-tag-selected' : ''}" 
                                                                  data-tag="${id}" ${isSelected ? 'data-selected="true"' : ''}>
                                                                ${tag}
                                                                ${isSelected ? '<span class="selected-check">✓</span>' : ''}
                                                            </span>
                                                        `;
                                                    }).join('') : 
                                                    '<div class="no-tags">No tags</div>'
                                                }
                                            </div>
                                            <div class="letter-divider"></div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);

            $('body').append(modal);

            if (!modalEventHandlersAttached) {
                $('body').on('input', '.tag-search-input', function() {
                    const searchText = $(this).val().toLowerCase();

                    if (searchText.length === 0) {
                        $('.letter-group').show();
                        $('.modal-tag').show();
                        return;
                    }

                    $('.letter-group').each(function() {
                        const $group = $(this);
                        let hasMatches = false;

                        $group.find('.modal-tag').each(function() {
                            const tagText = $(this).text().toLowerCase();
                            const isMatch = tagText.includes(searchText);
                            $(this).toggle(isMatch);
                            if (isMatch) hasMatches = true;
                        });

                        $group.toggle(hasMatches || $group.find('.letter-header').text().toLowerCase().includes(searchText));
                    });
                });

                $('body').on('click', '.modal-tag:not(.modal-tag-selected)', function() {
                    const tagId = parseInt($(this).data('tag'));
                    if (!selectedTags.includes(tagId)) {
                        selectedTags.push(tagId);
                        $(this)
                            .addClass('modal-tag-selected')
                            .attr('data-selected', 'true')
                            .append('<span class="selected-check">✓</span>');

                        filterGames();
                    }
                });

                modalEventHandlersAttached = true;
            }

            // $('body').on('click', '.modal-tag-selected', function() {
            //     const tagId = parseInt($(this).data('tag'));
            //     selectedTags = selectedTags.filter(id => id !== tagId);
            //     $(this)
            //         .removeClass('modal-tag-selected')
            //         .attr('data-selected', 'false');

            //     filterGames();
            // });

            // $('.modal-tag').on('click', function() {
            //     const tagId = $(this).data('tag');
            //     selectedTags.push(tagId);
            //     $('#tagsModal').modal('hide');
            //     filterGames();
            // });

            $('#tagsModal').on('hidden.bs.modal', function() {
                $(this).remove();
            });

            $('#tagsModal').modal('show');
        }

        function renderTagFilter() {
            const tagsContainer = $('#tagsFilterContainer');
            if (!tagsContainer.length) {
                $('.filter-container').append(`
                    <div class="filter-group">
                        <div id="tagsFilterContainer" class="tags-filter-container"></div>
                    </div>
                `);
            }

            const container = $('#tagsFilterContainer');
            container.empty();

            selectedTags.forEach(tagId => {
                const tagName = allAvailableTags[tagId] || tagId;
                container.append(`
                    <span class="filter-tag" data-tag="${tagId}">
                        ${tagName} <span class="remove-tag">×</span>
                    </span>
                `);
            });

            container.append(`
                <span class="filter-tag add-tag" id="addTagButton">
                    + <span class="add-tag-text">Add tag</span>
                </span>
            `);

            $('.remove-tag').on('click', function(e) {
                e.stopPropagation();
                const tagId = $(this).parent().data('tag');
                selectedTags = selectedTags.filter(id => id !== tagId);
                filterGames();
            });

            $('#addTagButton').on('click', showTagModal);
        }

        $(document).ready(() => {
            $('#winFilter').change(function() {
                platformFilters.win = $(this).is(':checked');
                filterGames();
            });
            
            $('#macFilter').change(function() {
                platformFilters.mac = $(this).is(':checked');
                filterGames();
            });
            
            $('#linuxFilter').change(function() {
                platformFilters.linux = $(this).is(':checked');
                filterGames();
            });
            
            $('#vrFilter').change(function() {
                vrFilter = $(this).is(':checked');
                filterGames();
            });
            
            $('#appFilter').change(function() {
                appFilter = $(this).is(':checked');
                filterGames();
            });

            $('#bundleFilter').change(function() {
                bundleFilter = $(this).is(':checked');
                filterGames();
            });
            
            $('#soundtrackFilter').change(function() {
                soundtrackFilter = $(this).is(':checked');
                filterGames();
            });

            $.getJSON("./tags.json")
             .done(steamTags => {
                allAvailableTags = steamTags;
            })
             .fail(() => console.error('Error loading data')); 

            $.getJSON("./free_goods_detail.json")
             .done(data => {
                $('#uptime').text(data.update_time);
                allGames = data.free_list.map(item => {
                    const price = item[2].toLowerCase() === 'free' ? 0 : parseFloat(item[2].replace(/[^\d.]/g, '')) || 0;
                    const tags = item[6].map(id => allAvailableTags[id]);

                    return {
                        discount: item[0],
                        originalPrice: item[1],
                        discountPrice: item[2],
                        name: item[3],
                        link: item[4],
                        image: item[5],
                        numericPrice: price,
                        numericTags: item[6],
                        tags: tags,
                        is_bundle: item[7],
                        is_soundtrack: item[8],
                        for_win: item[9],
                        for_mac: item[10],
                        for_linux: item[11],
                        for_vr: item[12]
                    };
                });

                const maxPrice = Math.ceil(Math.max(...allGames.map(g => g.numericPrice))) || 100;
                initSliders(maxPrice);
                filterGames();

                $('#nameFilter').on('input', debouncedFilter);
            })
            .fail(() => console.error('Error loading data'));
        });
    </script>
</body>
</html>
